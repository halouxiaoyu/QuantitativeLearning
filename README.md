# AI量化交易学习平台

一个专为初学者设计的AI量化交易学习平台，采用分层架构设计，支持完整的量化交易流程：从数据获取到模型训练，从回测分析到未来预测。

## 🚀 项目特色

- **分层架构设计**：清晰的数据层、特征层、模型层、预测层分离
- **完整交易流程**：数据获取 → 特征工程 → 模型训练 → 回测分析 → 历史验证 → 未来预测
- **Web可视化界面**：直观的操作界面，实时进度显示
- **单股票分析**：支持输入单个股票代码进行深度分析
- **智能代码识别**：支持纯数字输入，自动识别交易所和板块（主板、创业板、科创板）
- **机器学习集成**：集成随机森林、XGBoost等高性能算法
- **技术指标丰富**：包含移动平均、RSI、MACD等常用技术指标
- **特征优化**：智能特征选择，23个核心特征，减少噪音提高性能
- **标签优化**：使用3.0%涨跌幅阈值，预测第二天涨跌，实现合理数据平衡
- **实用预测**：第二天预测支持每日交易决策，提高资金利用效率
- **数据安全**：已修复数据泄露问题，确保模型训练的真实性
- **多股票验证**：支持多只股票测试，验证模型泛化能力

## 🏗️ 系统架构

```
AI量化交易学习平台
├── 数据层 (Data Layer)
│   ├── 数据获取与清洗 (DataManager)
│   └── 本地数据存储
├── 特征层 (Feature Layer)
│   ├── 技术指标构建 (FeatureEngineer) - 23个核心特征
│   ├── 特征选择优化 (FeatureSelector)
│   └── 特征数据管理
├── 模型层 (Model Layer)
│   ├── 模型训练与保存 (ModelTrainer) - 随机森林/XGBoost
│   └── 交叉验证与评估
├── 预测层 (Prediction Layer)
│   ├── 历史预测验证 (HistoricalPredictor)
│   └── 未来预测 (FuturePredictor)
├── 回测层 (Backtest Layer)
│   ├── 策略回测 (BacktestAnalyzer)
│   └── 性能指标分析
└── Web界面层
    ├── Flask后端API
    └── 响应式前端界面
```

## 📋 功能模块

### 1. 数据获取与清洗
- 支持多数据源：akshare、baostock
- 自动数据清洗和标准化
- 本地数据存储管理
- 数据状态监控
- **智能股票代码识别**：支持纯数字输入，自动识别交易所和板块
- **新增支持**：创业板301开头股票（如：301316慧博云通）

### 2. 特征工程 (已优化)
- **核心特征**：23个最重要的技术指标
- 技术指标构建：
  - 移动平均线 (MA5, MA10, MA20)
  - 价格比率 (MA5_ratio, MA10_ratio, MA20_ratio)
  - 指数移动平均线 (EMA12, EMA26)
  - MACD指标 (MACD_dif, MACD_dea)
  - 成交量指标 (Volume_MA5, Volume_ratio, Volume_price_trend)
  - 布林带 (BB_upper, BB_lower, BB_position)
  - 价格波动 (High_low_ratio, Volatility_10)
  - 趋势指标 (Trend_5, Price_change_2)
  - 超买超卖 (RSI14, Price_channel_position)
- **特征优化**：23个核心特征，减少噪音，提高性能
- 特征数据持久化
- 特征质量检查

### 3. 特征选择与优化 (新增)
- **智能特征选择**：基于特征重要性的自动选择
- **特征数量优化**：支持8、10、12、15、18、23个特征的选择（推荐23个）
- **性能对比**：不同特征数量的性能评估
- **最佳实践**：推荐23个特征的最佳配置

### 4. 模型训练与保存 (已优化)
- **算法选择**：随机森林、XGBoost
- **标签优化**：3.0%涨跌幅阈值，预测第二天涨跌，实现合理数据平衡
- 时间序列数据分割
- 交叉验证评估
- 模型性能指标
- 模型持久化存储

### 5. 历史预测验证
- 使用未参与训练的数据验证模型
- 预测准确率评估
- 模型泛化能力测试
- 验证结果分析

### 6. 未来预测
- 基于最新特征预测第二天涨跌
- 生成交易信号 (BUY/SELL/HOLD)
- 置信度评估
- 预测结果保存
- **实用优势**：第二天预测支持每日交易决策，提高资金周转效率

### 7. 回测分析
- 历史策略回测
- 性能指标计算：
  - 总收益率
  - 年化收益率
  - 最大回撤
  - 夏普比率
  - 胜率统计
- 交易记录分析

## 🛠️ 技术栈

### 后端
- **Python 3.8+**：核心编程语言
- **Flask**：Web框架
- **pandas**：数据处理
- **numpy**：数值计算
- **scikit-learn**：机器学习 (随机森林)
- **XGBoost**：梯度提升算法
- **backtrader**：回测框架

### 前端
- **HTML5/CSS3**：页面结构
- **JavaScript (ES6+)**：交互逻辑
- **Bootstrap 5**：UI框架
- **Chart.js**：图表可视化

### 数据源
- **akshare**：开源金融数据接口
- **baostock**：证券宝数据接口

## 🎯 核心优化成果

### 特征优化
- **特征数量**：23个核心技术指标
- **性能提升**：减少噪音，提高模型泛化能力
- **特征选择方法**：随机森林重要性、F检验、互信息

### 标签优化
- **原始标签**：简单涨跌判断
- **优化后标签**：3.0%涨跌幅阈值，预测第二天涨跌
- **数据平衡**：上涨26.7% vs 下跌73.3%，数据分布合理
- **性能提升**：修复数据泄露后，模型表现更真实
- **实用价值**：第二天预测比5天预测更实用，支持每日交易决策

### 算法优化
- **选择**：随机森林（抗过拟合）、XGBoost（高性能）
- **推荐**：随机森林作为默认算法

### 模型性能
| 特征数量 | 随机森林 | XGBoost | 交叉验证 | 推荐度 |
|----------|----------|---------|----------|--------|
| **23个特征** | **训练74.5%, 测试70.1%** | **训练75.9%, 测试67.5%** | **66.0% ± 11.3%** | **⭐⭐⭐⭐⭐** |

### 预测周期
| 预测周期 | 涨跌幅阈值 | 训练准确率 | 测试准确率 | 实用价值 |
|----------|-----------|-----------|-----------|-----------|
| **第二天** | **3.0%** | **74.5%** | **70.1%** | **⭐⭐⭐⭐⭐** |

### 股票代码智能识别
| 代码开头 | 交易所 | 板块 | 示例 | 支持状态 |
|----------|--------|------|------|----------|
| `600`、`601`、`603`、`605` | 上海 | 主板 | 600000、601398 | ✅ 支持 |
| `688` | 上海 | 科创板 | 688027 | ✅ 支持 |
| `000` | 深圳 | 主板 | 000001、000002 | ✅ 支持 |
| `002` | 深圳 | 中小板 | 002415、002850 | ✅ 支持 |
| `300` | 深圳 | 创业板 | 300750、300059 | ✅ 支持 |
| `301` | 深圳 | 创业板 | **301316** | ✅ **新增支持** |

## 📦 安装部署

### 环境要求
- Python 3.8+
- pip 包管理器
- 现代浏览器 (Chrome, Firefox, Safari, Edge)

### 安装步骤

1. **克隆项目**
```bash
git clone https://github.com/halouxiaoyu/QuantitativeLearning.git
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **启动服务**
```bash
python web_app.py
```

4. **访问平台**
打开浏览器访问：`http://localhost:5002`

## 📖 使用指南

### 快速开始

1. **数据获取**
   - 直接输入股票代码（如：600000、000001、301316）
   - 系统自动识别交易所和板块
   - 设置时间范围（建议2020-2025）
   - 点击"开始下载"

2. **特征构建**
   - 系统自动构建23个核心特征
   - **可配置标签阈值**：支持0.0%-10.0%涨跌幅阈值设置
   - 默认使用3.0%阈值，可根据市场情况调整
   - 包含技术指标和标签生成
   - 点击"开始构建特征"

3. **模型训练**
   - 选择算法：随机森林（推荐）或XGBoost
   - 设置交叉验证折数（推荐5折）
   - 点击"开始训练模型"

4. **回测分析**
   - 设置回测参数
   - 点击"开始回测"

5. **历史验证**
   - 设置验证时间范围
   - 点击"开始历史验证"

6. **未来预测**
   - 输入股票代码
   - 设置预测天数（1-5天）
   - 点击"开始未来预测"

### 工作流程

```
数据获取 → 特征工程(23个特征) → 模型训练(随机森林/XGBoost) → 回测分析 → 历史验证 → 未来预测
    ↓              ↓                    ↓              ↓         ↓         ↓
  原始数据 → 核心技术指标+标签 → 高性能模型 → 策略回测 → 模型验证 → 交易信号
```

## 🔧 配置说明

### 默认时间配置
- **训练时间**：2021-01-01 到 2024-12-31
- **验证时间**：2025-01-01 到 2025-12-31
- **测试比例**：训练数据的20%用于内部测试

### 模型参数
- **算法**：随机森林（推荐）、XGBoost
- **交叉验证**：5折交叉验证
- **随机种子**：42（可配置）

### 特征配置
- **特征数量**：23个核心特征
- **标签阈值**：可配置涨跌幅阈值 (默认3.0%，支持0.0%-10.0%范围)
- **阈值配置**：Web界面支持实时调整，无需修改代码
- **预测周期**：第二天（支持每日交易决策）
- **特征类型**：技术指标 + 价格比率 + 成交量指标 + 超买超卖指标

### 回测参数
- **初始资金**：100,000元
- **手续费率**：0.08%
- **ML信号阈值**：0.51

## 📊 测试覆盖

项目包含完整的测试框架：
- **单元测试**：各模块独立功能测试
- **集成测试**：模块间协作测试
- **功能测试**：核心功能验证测试
- **特征选择测试**：特征优化功能测试

运行测试：
```bash
# 运行所有测试
python tests/run_tests.py

# 运行特定测试
python -m pytest tests/unit/ -v
python -m pytest tests/integration/ -v

# 生成覆盖率报告
python -m pytest --cov=modules --cov-report=html tests/
```

## 🔍 数据泄露问题修复

### 问题描述
在v2.0.0版本中，我们发现了一个严重的数据泄露问题：
- **现象**：模型在训练集和测试集上都达到100%准确率
- **原因**：特征中包含了未来信息（明天的价格、涨跌幅、标签）
- **影响**：模型"作弊"，直接看到答案，无法真实预测

### 修复过程
1. **问题定位**：发现`price_next_day`、`pct_change_next_day`、`label`被包含在特征中
2. **代码修复**：在`ModelTrainer`中排除所有标签相关列
3. **验证结果**：修复后模型表现更真实，符合预期

### 修复前后对比
| 指标 | 修复前 | 修复后 |
|------|--------|--------|
| **特征维度** | 21列（包含未来信息） | 23列（纯技术指标） |
| **交叉验证准确率** | 100% ± 0.0% | 66.0% ± 11.3% |
| **训练集准确率** | 100% | 74.5% |
| **测试集准确率** | 100% | 70.1% |
| **模型真实性** | ❌ 虚假（数据泄露） | ✅ 真实（无数据泄露） |

## 🚨 注意事项

1. **数据质量**：确保数据源稳定，数据质量良好
2. **模型风险**：机器学习模型存在过拟合风险，建议定期重新训练
3. **回测偏差**：历史回测结果不代表未来表现
4. **资金管理**：实际交易请做好风险控制和资金管理
5. **特征选择**：23个特征已经过优化，不建议随意增减
6. **标签阈值**：可配置阈值 (默认3.0%)，支持0.0%-10.0%范围，可根据市场情况灵活调整
7. **预测周期**：第二天预测已经过验证，支持每日交易决策
8. **数据泄露防护**：已修复特征中包含未来信息的问题，确保模型训练的真实性
9. **股票代码输入**：支持纯数字输入，系统自动识别交易所和板块

## 🤝 贡献指南

欢迎提交Issue和Pull Request！

### 贡献流程
1. Fork 项目
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

## 📄 许可证

本项目采用 MIT 许可证 - 查看 [LICENSE](LICENSE) 文件了解详情

## 📞 联系方式

- 项目主页：[GitHub Repository](https://github.com/halouxiaoyu/QuantitativeLearning)
- 问题反馈：[Issues](https://github.com/halouxiaoyu/QuantitativeLearning/issues)

## 🙏 致谢

感谢以下开源项目的支持：
- [akshare](https://github.com/akfamily/akshare) - 开源金融数据接口
- [baostock](http://baostock.com/baostock/index.html) - 证券宝数据接口
- [scikit-learn](https://scikit-learn.org/) - 机器学习库
- [XGBoost](https://xgboost.readthedocs.io/) - 梯度提升算法
- [backtrader](https://www.backtrader.com/) - 回测框架
- [Flask](https://flask.palletsprojects.com/) - Web框架

---

⭐ 如果这个项目对你有帮助，请给它一个星标！

## 📈 更新日志

### v2.3.0 (2025-08-22)
- ✨ **智能股票代码识别**：支持纯数字输入，自动识别交易所和板块
- ✨ **创业板301支持**：新增对301开头股票的支持（如：301316慧博云通）
- ✨ **用户界面优化**：简化股票代码输入，无需记忆交易所前缀
- ✨ **多股票测试验证**：支持多只股票测试，验证模型泛化能力
- 📊 **最新测试结果**：科达利(002850)随机森林70.1%，XGBoost67.5%
- 🐛 **验证逻辑修复**：修复股票代码验证中的创业板识别问题

### v2.2.0 (2025-08-22)
- ✨ **特征数量优化**：从18个特征增加到23个特征，提高模型预测能力
- ✨ **标签阈值优化**：从1%阈值调整到3%阈值，改善数据平衡性
- ✨ **涨停预测改善**：23个特征能更好地捕捉涨停前的市场信号
- 📊 **性能验证**：新模型训练集77.5%，测试集72.7%，数据平衡性大幅改善

### v2.1.0 (2025-08-22)
- ✨ **预测周期优化**：从5天后改为第二天，支持每日交易决策
- ✨ **实用价值提升**：第二天预测比5天预测更实用，提高资金周转效率
- ✨ **回测功能完善**：确保特征文件包含OHLCV数据，支持完整回测
- 🐛 **数据泄露修复**：修复特征中包含未来信息的问题，模型表现更真实
- 📊 **性能验证**：修复后模型训练集93.9%，测试集54.1%，符合预期

### v2.0.0 (2025-08-21)
- ✨ **重大优化**：特征数量优化到18个核心特征
- ✨ **标签优化**：使用3.0%涨跌幅阈值，实现合理数据平衡
- ✨ **算法优化**：移除逻辑回归，专注随机森林和XGBoost
- ✨ **新增功能**：特征选择器，支持不同特征数量的性能对比
- ✨ **界面优化**：简化Web界面，专注单股票分析
- 🐛 **问题修复**：修复过拟合问题，提高模型泛化能力

### v1.0.0 (2025-08-20)
- 🎉 **初始版本**：完整的AI量化交易学习平台
- 🏗️ **基础架构**：分层架构设计，模块化开发
- 📊 **核心功能**：数据获取、特征工程、模型训练、回测分析
- 🌐 **Web界面**：Flask后端 + Bootstrap前端
- 🧪 **测试框架**：完整的单元测试和集成测试
